<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previsioni di Mercato - {{ ticker }}</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- Stili Personalizzati -->
    <style>
        body {
            background-color: rgb(25, 25, 25);
        }

        .prediction-item {
            border-left: 5px solid #dee2e6;
            transition: transform 0.2s;
        }
        
        .prediction-item:hover {
            transform: translateX(5px);
        }

        .pred-buy {
            border-left-color: #198754; 
        }

        .pred-sell {
            border-left-color: #ffc107; 
        }

        .badge-today {
            font-size: 0.7em;
            vertical-align: middle;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="pb-5">

    <nav class="navbar navbar-dark bg-dark mb-4 shadow-sm">
        <div class="container">
            <span class="navbar-brand mb-0 h1">Ticker Tracker</span>
            <span class="text-white-50">Guidetti Samuele & Marianelli Alessio</span>
        </div>
    </nav>

    <div class="container">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold mb-0">Analisi Ticker: <span class="badge bg-primary">{{ ticker }}</span></h2>
            </div>
            <div>
                <a href="/" class="btn btn-outline-secondary btn-sm">Aggiorna Dati</a>
            </div>
        </div>

        <div class="row g-4">
            
            <!-- Grafici con Accordion -->
            <div class="col-lg-8">
                <div class="card shadow-sm h-100 border-0">
                    <div class="card-header bg fw-bold py-3">
                        Prezzo di chiusura {{ticker}}
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="chartsAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingLine">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLine" aria-expanded="true" aria-controls="collapseLine">
                                        Grafico Lineare
                                    </button>
                                </h2>
                                <div id="collapseLine" class="accordion-collapse collapse show" aria-labelledby="headingLine">
                                    <div class="accordion-body">
                                        <div style="height: 450px; background-color: #0b0b0b; border-radius:6px;">
                                            {{ line_div | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingCandle">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCandle" aria-expanded="false" aria-controls="collapseCandle">
                                        Candlestick (OHLC)
                                    </button>
                                </h2>
                                <div id="collapseCandle" class="accordion-collapse collapse" aria-labelledby="headingCandle">
                                    <div class="accordion-body">
                                        <div style="height: 450px; background-color: #0b0b0b; border-radius:6px;">
                                            {{ candle_div | safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista Previsioni -->
            <div class="col-lg-4" style="height: fit-content;">
                <div class="card shadow-sm h-100 border-0">
                    <div class="card-header bg fw-bold py-3 d-flex justify-content-between align-items-center">
                        <span>Previsioni del Modello</span>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            
                            {% if predictions %}
                                {% for pred in predictions %}
                                <div class="list-group-item prediction-item py-3 {% if pred.signal == 'BUY' %}pred-buy{% else %}pred-sell{% endif %}">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        
                                    
                                        <div>
                                            <div class="fw-bold text-secondary">
                                                {{ pred.date }}
                                                {% if pred.is_today %}
                                                    <span class="badge bg-primary    badge-today ms-1">OGGI</span>
                                                {% endif %}
                                            </div>
                                            <div class="small text-muted">
                                                Close: <span class="fw-bold text-secondary">${{ pred.close }}</span>
                                            </div>
                                        </div>

                                        <!-- Lato Destro: Segnale e Barre -->
                                        <div class="text-end" style="min-width: 110px;">
                                            
                                           
                                            <div class="fw-bold mb-1 {% if pred.signal == 'BUY' %}text-success{% else %}text-danger{% endif %}">
                                                {{ pred.signal }}
                                            </div>

                                            <!-- Visualizzazione Probabilità -->
                                            <div class="progress mb-1" style="height: 6px; background-color: #e9ecef;">
                                                <div class="progress-bar {% if pred.signal == 'BUY' %}bg-success{% else %}bg-danger{% endif %}" 
                                                     role="progressbar"
                                                     style="width: {{pred.prob}}%" 
                                                     aria-valuenow="{{ pred.prob }}" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between text-muted" style="font-size: 0.7rem; gap:10px;  ">
                                                <span>Probabilità Predizione: <b>{{ pred.prob }}%</b> </span>
                                                <span title="Soglia Dinamica">Soglia: <b> {{ pred.thresh }}% </b></span>
                                            </div>

                                        </div>

                                    </div>
                                </div>
                                {% endfor %}
                            
                            {% else %}
                                <!-- Caso Nessuna Previsione -->
                                <div class="text-center p-5">
                                    <h5 class="text-muted">Dati non disponibili</h5>
                                    <p class="small text-secondary">Verifica che il modello sia caricato correttamente.</p>
                                </div>
                            {% endif %}

                        </div>
                    </div>
                    <div class="card-footer bg text-center small text-muted">
                        *Soglia calcolata sugli ultimi 40 giorni
                    </div>
                </div>
            </div>

        </div> <!-- Fine Row -->
    </div> <!-- Fine Container -->

    <!-- JAVASCRIPT SECTION -->
    <!-- Grafici già renderizzati lato server come DIV Plotly; non serve JS custom qui -->

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Resize Plotly charts when a collapse is shown -->
    <script>
        document.addEventListener('shown.bs.collapse', function (event) {
            var collapseEl = event.target;
            var plotEls = collapseEl.querySelectorAll('.plotly-graph-div');
            plotEls.forEach(function (el) {
                if (window.Plotly && Plotly.Plots && typeof Plotly.Plots.resize === 'function') {
                    try { Plotly.Plots.resize(el); } catch (e) {}
                }
            });
        });
    </script>

</body>
</html>